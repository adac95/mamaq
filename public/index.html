<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="create-item.css">
    <title>crear productos</title>
</head>

<body>
    <main>
        <section class="create-item-section">
            <form class="create-item__form" id="createForm">
                <label class="form__label" for="name">Nombre
                    <input class="form__input" type="text" id="name" required>
                </label>
                <label class="form__label" for="price">Precio
                    <input class="form__input" type="number" id="price" required>
                </label>
                <label class="form__label" for="category">Categoria
                    <input class="form__input" type="text" id="category" required>
                </label>
                <input class="form__input form__input--submit" type="submit" value="Crear item">
            </form>
        </section>
        <section id="list-item-section" class="list-item-section">
            <h2>Productos</h2>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>Categoria</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>
    <template id="items-template">
        <tr class="item-tr">
            <td class="item-name"></td>
            <td class="item-price"></td>
            <td class="item-category"></td>
            <td class="td-btn">
                <button class="edit-btn">Editar</button>
                <button class="delete-btn">Eliminar</button>
            </td>
        </tr>
    </template>
    <script>


        // GET 

        const d = document,
            $table = d.querySelector(".items-table"),
            $template = d.getElementById("items-template").content,
            $fragment = d.createDocumentFragment();
            
            
            const getAll = async () => {
                try {
                    let res = await fetch("http://localhost:3001/products")
                    let json = await res.json()
                    if (!res.ok) throw { status: res.status, statusText: res.statusText }
                    
                    // let cuerpo = json.body
                    // ant = [...cuerpo]
                    
                    json.body.forEach(el => {
                        $template.querySelector(".item-name").textContent = el.name;
                        $template.querySelector(".item-price").textContent = el.price;
                        $template.querySelector(".item-category").textContent = el.category;
                        $template.querySelector(".edit-btn").dataset._id = el._id;
                        $template.querySelector(".item-tr").dataset._id = el._id;
                        $template.querySelector(".item-tr").dataset.name = el.name;
                        $template.querySelector(".item-tr").dataset.price = el.price;
                        $template.querySelector(".item-tr").dataset.category = el.category;
                        $template.querySelector(".delete-btn").dataset._id = el._id;

                        let $clone = d.importNode($template, true);
                        $fragment.appendChild($clone);
                    });
                    
                    $table.querySelector("tbody").appendChild($fragment);


                    // PUT

                    $table.addEventListener("click", async e => {

                        try {
                            let id = e.target.dataset._id
                        const trs = [...document.querySelectorAll(".item-tr")]

                        let $input, $input1, $input2;

                        const tr =  trs.find(el => el.dataset._id == id)
                        if(e.target.textContent === "Editar") {
                            


                            const $input = document.createElement("input")
                            const $input1 = document.createElement("input")
                            const $input2 = document.createElement("input")
                            $input.type = "text"
                            $input1.type = "text"
                            $input2.type = "text"
                            // console.log(tr)

                            tr.querySelector(".item-name").textContent = ""
                            tr.querySelector(".item-name").appendChild($input).value = tr.dataset.name
                            tr.querySelector(".item-price").textContent = ""
                            tr.querySelector(".item-price").appendChild($input1).value = tr.dataset.price
                            tr.querySelector(".item-category").textContent = ""
                            tr.querySelector(".item-category").appendChild($input2).value = tr.dataset.category


                            addEventListener("keyup", el => {

                                e.target.dataset.name = $input.value
                                e.target.dataset.price = $input1.value
                                e.target.dataset.category = $input2.value
                            })
                            
                            e.target.textContent = "Aceptar"
                            tr.querySelector(".delete-btn").textContent = "Cancelar"
                        }
                        else if(e.target.textContent ===  "Cancelar") {
                            // console.log("object")
                            tr.querySelector(".item-name").textContent = tr.dataset.name
                            tr.querySelector(".item-price").textContent = tr.dataset.price
                            tr.querySelector(".item-category").textContent = tr.dataset.category
                            e.target.textContent = "Eliminar"
                            tr.querySelector(".edit-btn").textContent = "Editar"
                        }
                        else if(e.target.textContent ===  "Aceptar") {

                            let options = {
                                method: "PATCH",
                                headers: {
                                    "Content-type": "application/json; charset=utf-8"
                                },
                                body: JSON.stringify({
                                    name: e.target.dataset.name,
                                    price: e.target.dataset.price,
                                    category: e.target.dataset.category
                                })}
                                // console.log(options.body)

                            res = await fetch(`http://localhost:3001/products/${e.target.dataset._id}`, options),
                            json = await res.json();
                            tr.querySelector(".item-name").textContent = e.target.dataset.name
                            tr.querySelector(".item-price").textContent = e.target.dataset.price
                            tr.querySelector(".item-category").textContent = e.target.dataset.category
                            tr.dataset.name = e.target.dataset.name
                            tr.dataset.price = e.target.dataset.price
                            tr.dataset.category = e.target.dataset.category

                            e.target.textContent = "Editar"

                            
                                }
                        }catch(error){
                            console.log(error, "error al actualizar")
                         }


                    // DELETE 

                        if(e.target.textContent === "Eliminar") {
                            try {
                                
                                let options = {
                                method: "DELETE",
                                headers: {
                                    "Content-type": "application/json; charset=utf-8"
                                }
                                },
                                res = await fetch(`http://localhost:3001/products/${e.target.dataset._id}`, options),
                                json = await res.json();

                                if (!res.ok) throw { status: res.status, statusText: res.statusText };

                                location.reload();
                            } catch (err) {
                                let message = err.statusText || "OcurriÃ³ un error";
                                alert(`Error ${err.status}: ${message}`);
                            }
                        }

                    })

                   

            } catch (error) {
                let message = error.statusText || "ocurrio un error"
                console.log(error)
                $table.textContent = message
            }
        }
        document.addEventListener("DOMContentLoaded", getAll)

        // POST

        document.addEventListener("submit", async e => {

            $form = document.getElementById("createForm")
            if (e.target == $form) { e.preventDefault() }
            try {
                let options = {
                    method: "POST",
                    headers: {
                        "content-type": "application/json; charset=utf-8"
                    },
                    body: JSON.stringify({
                        name: e.target.name.value,
                        price: e.target.price.value,
                        category: e.target.category.value,
                    })
                }

                let res = await fetch("http://localhost:3001/products", options);

                let json = await res.json();

                $form.reset()
                location.reload();
                // getAll();


            } catch (error) {
                console.log(e.error)
            }
        })

        // Delete 


        



    </script>
</body>

</html>